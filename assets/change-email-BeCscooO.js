import{k as B,r as u,l as K,j as e,B as x}from"./index-Bn_bHuoN.js";import{o as T,s as b,F as w,a as g,c as p,d as f,e as j,f as y,t as C}from"./form-Cx6pTLvW.js";import{u as F,I as v}from"./input-C4CD33dg.js";import{C as N,a as k,b as V,c as E,d as L}from"./card-DIz8FuQ8.js";import{u as P,e as M}from"./fetch-CWuzVEnS.js";function A(){const{executePost:s,isLoading:m,isError:c}=P(M.changeEmail());return{changeEmail:async o=>{const t=await s(o);if(t!=null&&t.success)return t==null?void 0:t.success;throw new Error(t==null?void 0:t.message)},isLoading:m,isError:c}}function D(){const{executePost:s,isLoading:m,isError:c}=P(M.validChangeEmail());return{validChangeEmail:async o=>{const t=await s(o);if(t!=null&&t.success)return t==null?void 0:t.success;throw new Error(t==null?void 0:t.message)},isLoading:m,isError:c}}const G=T({email:b({required_error:"Email là bắt buộc"}).email("Email không hợp lệ"),currentPassword:b().min(1,"Yêu cầu nhập mật khẩu hiện tại.")}),H=T({code:b().min(6,"Mã xác thực phải có ít nhất 6 ký tự")}),O=()=>{const{toast:s}=B(),[m,c]=u.useState("email"),[l,o]=u.useState(120),[t,d]=u.useState(!1),{userInfo:h,updateUserInfo:I}=K(),{changeEmail:S}=A(),{validChangeEmail:R}=D(),a=F({resolver:C(G),defaultValues:{email:""}}),n=F({resolver:C(H),defaultValues:{code:""}});u.useEffect(()=>{let i;return l>0?i=setInterval(()=>{o(r=>r-1)},1e3):d(!0),()=>clearInterval(i)},[l]);const q=async()=>{try{if(d(!1),!await S({email:a.getValues("email"),current_password:a.getValues("currentPassword")})){s({variant:"destructive",title:"Lỗi",description:"Không thể gửi lại mã xác thực"}),d(!0);return}o(120),s({title:"Thành công",description:"Mã xác thực mới đã được gửi"})}catch(i){s({variant:"destructive",title:"Lỗi",description:i instanceof Error?i.message:"Đã có lỗi xảy ra"}),d(!0)}},X=async i=>{try{if(!await S({email:i.email,current_password:i.currentPassword})){s({variant:"destructive",title:"Lỗi",description:"Đã có lỗi xảy ra"});return}o(120),d(!1),c("verify"),s({title:"Thành công",description:"Vui lòng kiểm tra email để lấy mã xác thực"})}catch(r){s({variant:"destructive",title:"Lỗi",description:r instanceof Error?r.message:"Đã có lỗi xảy ra"})}},_=async i=>{try{if(!await R({code:i.code})){s({variant:"destructive",title:"Lỗi",description:"Đã có lỗi xảy ra"});return}s({title:"Thành công",description:"Email đã được thay đổi thành công"}),a.reset(),n.reset(),c("email"),I({...h,"2fa":"0",VerifiedEmail:"0"})}catch(r){s({variant:"destructive",title:"Lỗi",description:r instanceof Error?r.message:"Đã có lỗi xảy ra"})}};return m==="verify"?e.jsx("div",{className:"container mx-auto max-w-md py-8",children:e.jsxs(N,{children:[e.jsxs(k,{children:[e.jsx(V,{children:"Xác thực thay đổi email"}),e.jsxs(E,{className:"space-y-2",children:[e.jsxs("p",{children:["Vui lòng nhập mã xác thực đã được gửi đến email: ",h==null?void 0:h.Email]}),l>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Mã xác thực còn hiệu lực trong: ",l,"s"]})]})]}),e.jsx(L,{children:e.jsx(w,{...n,children:e.jsx("form",{onSubmit:n.handleSubmit(_),id:"valid-email",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(g,{control:n.control,name:"code",render:({field:i})=>e.jsxs(p,{children:[e.jsx(f,{children:"Mã xác thực"}),e.jsx(j,{children:e.jsx(v,{...i,type:"text",placeholder:"Nhập mã xác thực"})}),e.jsx(y,{})]})}),e.jsxs("div",{className:"flex justify-between gap-3",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>{c("email"),n.reset()},children:"Quay lại"}),t&&e.jsx(x,{type:"button",variant:"outline",onClick:q,children:"Gửi lại mã"})]}),e.jsx(x,{type:"submit",form:"valid-email",disabled:n.formState.isSubmitting||l<=0||!n.formState.isValid,children:n.formState.isSubmitting?"Đang xác thực...":"Xác thực"})]})]})})})})]})}):e.jsx("div",{className:"container mx-auto max-w-xl py-8",children:e.jsxs(N,{children:[e.jsxs(k,{children:[e.jsx(V,{children:"Thay đổi email"}),e.jsx(E,{children:"Sau khi thay đổi thành công Email trở về trạng thái chưa kích hoạt, đồng thời tính năng xác thực 2 lớp sẽ bị tắt."}),e.jsx(E,{children:"Sử dụng menu Xác thực email và Kích hoạt xác thực 2 lớp để bật lại các tính năng nâng cao."})]}),e.jsx(L,{children:e.jsx(w,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(X),className:"space-y-6",id:"request-change-email",children:[e.jsx(g,{control:a.control,name:"currentPassword",render:({field:i})=>e.jsxs(p,{children:[e.jsx(f,{children:"Mật khẩu hiện tại"}),e.jsx(j,{children:e.jsx(v,{type:"password",...i})}),e.jsx(y,{})]})}),e.jsx(g,{control:a.control,name:"email",render:({field:i})=>e.jsxs(p,{children:[e.jsx(f,{children:"Email mới"}),e.jsx(j,{children:e.jsx(v,{type:"email",placeholder:"Nhập địa chỉ email mới",...i})}),e.jsx(y,{})]})}),e.jsx(x,{type:"submit",form:"request-change-email",className:"w-fit flex justify-end",disabled:a.formState.isSubmitting,children:a.formState.isSubmitting?"Đang xử lý...":"Tiếp tục"})]})})})]})})};export{O as default};
