import{u as U,r as u,b as D,j as e,B as x,d as C}from"./index-DR-L-TCk.js";import{o as P,s as v,u as G,a as F,F as N,b as g,c as j,d as f,e as y,I as E,f as p,t as V}from"./use-alert-DIoakmlQ.js";import{a as L,c as T,C as k,e as b,b as I}from"./card-CqLdpYSs.js";import{a as M,e as R}from"./fetch-BJt4mAlt.js";function H(){const{executePost:r,isLoading:l,isError:m}=M(R.changeEmail());return{changeEmail:async i=>{try{return await r(i)}catch{throw new Error("error")}},isLoading:l,isError:m}}function K(){const{executePost:r,isLoading:l,isError:m}=M(R.validChangeEmail());return{validChangeEmail:async i=>{try{return await r(i)}catch{throw new Error("error")}},isLoading:l,isError:m}}const O=P({email:v({required_error:"Email là bắt buộc"}).email("Email không hợp lệ"),currentPassword:v().min(1,"Yêu cầu nhập mật khẩu hiện tại.")}),Q=P({code:v().min(6,"Mã xác thực phải có ít nhất 6 ký tự")}),Z=()=>{const r=G(),l=U(),[m,o]=u.useState("email"),[i,n]=u.useState(120),[_,h]=u.useState(!1),{userInfo:d,updateUserInfo:S}=D(),{changeEmail:w}=H(),{validChangeEmail:A}=K(),s=F({resolver:V(O),defaultValues:{email:""}}),c=F({resolver:V(Q),defaultValues:{code:""}});u.useEffect(()=>{let t;return i>0?t=setInterval(()=>{n(a=>a-1)},1e3):h(!0),()=>clearInterval(t)},[i]);const q=async()=>{try{h(!1);const t=await w({email:s.getValues("email"),current_password:s.getValues("currentPassword")});if(!(t!=null&&t.success)){r.error("Lỗi",t==null?void 0:t.message),h(!0);return}n(120),r.success("Thành công",t==null?void 0:t.message)}catch{r.error("Lỗi","Đã có lỗi xảy ra"),h(!0)}},X=async t=>{try{const a=await w({email:t.email,current_password:t.currentPassword});if(!(a!=null&&a.success)){r.error("Lỗi",a==null?void 0:a.message);return}if(a!=null&&a.success){r.success("Thành công",a==null?void 0:a.message),s.reset(),c.reset(),o("email"),l(C.VERIFy_EMAIL);return}S({...d,Email:a==null?void 0:a.data}),n(120),h(!1),o("verify"),r.success("Thành công","Vui lòng kiểm tra email để lấy mã xác thực")}catch(a){r.error("Lỗi",a instanceof Error?a.message:"Đã có lỗi xảy ra")}},B=async t=>{try{const a=await A({code:t.code});if(!(a!=null&&a.success)){r.error("Lỗi",a==null?void 0:a.message);return}r.success("Thành công",a==null?void 0:a.message),s.reset(),c.reset(),o("email"),S({...d,"2fa":"0",VerifiedEmail:"0"}),l(C.VERIFy_EMAIL)}catch(a){r.error("Lỗi",a instanceof Error?a.message:"Đã có lỗi xảy ra")}};return m==="verify"?e.jsx("div",{className:"container mx-auto max-w-md py-8",children:e.jsxs(L,{children:[e.jsxs(T,{children:[e.jsx(k,{children:"Xác thực thay đổi email"}),e.jsxs(b,{className:"space-y-2",children:[e.jsxs("p",{children:["Vui lòng nhập mã xác thực đã được gửi đến email: ",d==null?void 0:d.Email]}),i>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Mã xác thực còn hiệu lực trong: ",i,"s"]})]})]}),e.jsx(I,{children:e.jsx(N,{...c,children:e.jsx("form",{onSubmit:c.handleSubmit(B),id:"valid-email",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(g,{control:c.control,name:"code",render:({field:t})=>e.jsxs(j,{children:[e.jsx(f,{children:"Mã xác thực"}),e.jsx(y,{children:e.jsx(E,{...t,type:"text",placeholder:"Nhập mã xác thực"})}),e.jsx(p,{})]})}),e.jsxs("div",{className:"flex justify-between gap-3",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>{o("email"),c.reset()},children:"Quay lại"}),_&&e.jsx(x,{type:"button",variant:"outline",onClick:q,children:"Gửi lại mã"})]}),e.jsx(x,{type:"submit",form:"valid-email",disabled:c.formState.isSubmitting||i<=0||!c.formState.isValid,children:c.formState.isSubmitting?"Đang xác thực...":"Xác thực"})]})]})})})})]})}):e.jsx("div",{className:"container mx-auto max-w-xl py-8",children:e.jsxs(L,{children:[e.jsxs(T,{children:[e.jsx(k,{children:"Thay đổi email"}),e.jsx(b,{children:"Sau khi thay đổi thành công Email trở về trạng thái chưa kích hoạt, đồng thời tính năng xác thực 2 lớp sẽ bị tắt."}),e.jsx(b,{children:"Sử dụng menu Xác thực email và Kích hoạt xác thực 2 lớp để bật lại các tính năng nâng cao."})]}),e.jsx(I,{children:e.jsx(N,{...s,children:e.jsxs("form",{onSubmit:s.handleSubmit(X),className:"space-y-6",id:"request-change-email",children:[e.jsx(g,{control:s.control,name:"currentPassword",render:({field:t})=>e.jsxs(j,{children:[e.jsx(f,{children:"Mật khẩu hiện tại"}),e.jsx(y,{children:e.jsx(E,{type:"password",...t})}),e.jsx(p,{})]})}),e.jsx(g,{control:s.control,name:"email",render:({field:t})=>e.jsxs(j,{children:[e.jsx(f,{children:"Email mới"}),e.jsx(y,{children:e.jsx(E,{type:"email",placeholder:"Nhập địa chỉ email mới",...t})}),e.jsx(p,{})]})}),e.jsx(x,{type:"submit",form:"request-change-email",className:"w-fit flex justify-end",disabled:s.formState.isSubmitting,children:s.formState.isSubmitting?"Đang xử lý...":"Tiếp tục"})]})})})]})})};export{Z as default};
