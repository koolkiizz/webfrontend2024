import{k as _,r as x,j as e,B as v}from"./index-C_l3ICDN.js";import{o as D,s as j,u as M,F as X,a as p,c as C,d as S,e as f,f as y,t as G}from"./input-9AQyrjGS.js";import{V as U}from"./verify-form-K5-jcLQH.js";import{u as B,e as F,a as H,c as K,C as Q,f as I,b as z}from"./fetch-CghRpjQs.js";import{S as b,a as V,b as w,c as q,d as k}from"./select-av0SyYW7.js";import{u as A,a as J}from"./usePlayer-CSemXd7T.js";import"./index-7UV9yEwT.js";function O(){const{executePost:i,isLoading:o,isError:n}=B(F.requestClearBag());return{requestClearBag:async c=>{const r=await i(c);if(r!=null&&r.success)return r==null?void 0:r.success;throw new Error(r==null?void 0:r.message)},isLoading:o,isError:n}}function W(){const{executePost:i,isLoading:o,isError:n}=B(F.validClearBag());return{validClearBag:async c=>{const r=await i(c);if(r!=null&&r.success)return r==null?void 0:r.success;throw new Error(r==null?void 0:r.message)},isLoading:o,isError:n}}const Y=D({serverId:j({required_error:"Vui lòng chọn server"}),playerId:j({required_error:"Vui lòng chọn nhân vật"})}),ie=()=>{const{toast:i}=_(),[o,n]=x.useState("request"),[l,c]=x.useState(""),{serverData:r,isLoading:u}=A(!0),{playerData:d,isLoading:h}=J(l,!1),{requestClearBag:m,isLoading:g}=O(),{validClearBag:E}=W(),a=M({resolver:G(Y),defaultValues:{serverId:"",playerId:""}}),N=s=>{c(s),a.setValue("serverId",s),a.setValue("playerId","")},L=async s=>{try{await m({server_id:s.serverId,player_id:s.playerId})&&(n("verify"),i({title:"Thành công",description:"Vui lòng kiểm tra email để lấy mã xác thực"}))}catch(t){i({variant:"destructive",title:"Lỗi",description:t instanceof Error?t.message:"Đã có lỗi xảy ra"})}},P=async s=>{if(await E({code:s}))i({title:"Thành công",description:"Đã xóa mật khẩu túi đồ thành công"}),a.reset(),c(""),n("request");else throw new Error("Mã xác thực không đúng")},T=async()=>{try{const s=a.getValues();await m({server_id:s.serverId,player_id:s.playerId}),i({title:"Đã gửi lại mã",description:"Vui lòng kiểm tra email để lấy mã xác thực mới"})}catch{throw new Error("Không thể gửi lại mã xác thực")}},R=()=>{n("request"),a.reset(),c("")};return o==="verify"?e.jsxs("div",{className:"container mx-auto max-w-md py-8",children:[e.jsx(U,{title:"Xác thực xóa mật khẩu túi đồ",description:"Vui lòng nhập mã xác thực đã được gửi đến email của bạn",onSubmit:P,onResend:T,onExpired:R}),e.jsx("div",{className:"mt-4 flex justify-center",children:e.jsx(v,{variant:"outline",onClick:()=>{n("request")},children:"Quay lại"})})]}):e.jsx("div",{className:"container mx-auto max-w-2xl py-8",children:e.jsxs(H,{children:[e.jsxs(K,{children:[e.jsx(Q,{children:"Xóa mật khẩu túi đồ"}),e.jsx(I,{children:"Mật khẩu rương và câu hỏi bảo mật sẽ bị xóa khi thực hiện hành động này."}),e.jsx(I,{children:"Người chơi cần tải lại game khi tiến hành xóa mật khẩu."})]}),e.jsx(z,{children:e.jsx(X,{...a,children:e.jsxs("form",{onSubmit:a.handleSubmit(L),className:"space-y-6",id:"clear-bag",children:[e.jsx(p,{control:a.control,name:"serverId",render:({field:s})=>e.jsxs(C,{children:[e.jsx(S,{children:"Server"}),e.jsxs(b,{disabled:u,onValueChange:N,value:s.value,children:[e.jsx(f,{children:e.jsx(V,{children:e.jsx(w,{placeholder:u?"Đang tải...":"Chọn server"})})}),e.jsx(q,{children:r==null?void 0:r.map(t=>e.jsx(k,{value:t.ServerID.toString(),children:t.ServerName},t.ServerID))})]}),e.jsx(y,{})]})}),e.jsx(p,{control:a.control,name:"playerId",render:({field:s})=>e.jsxs(C,{children:[e.jsx(S,{children:"Nhân vật"}),e.jsxs(b,{disabled:!l||h,onValueChange:s.onChange,value:s.value,children:[e.jsx(f,{children:e.jsx(V,{children:e.jsx(w,{placeholder:l?h?"Đang tải...":"Chọn nhân vật":"Vui lòng chọn server trước"})})}),e.jsx(q,{children:d==null?void 0:d.map(t=>e.jsx(k,{value:t.UserID.toString(),children:t.NickName},t.UserID))})]}),e.jsx(y,{})]})}),e.jsx(v,{type:"submit",className:"w-full",form:"clear-bag",disabled:a.formState.isSubmitting||h||!l||!a.formState.isValid||g,children:g?"Đang xử lý...":"Xóa mật khẩu rương"})]})})})]})})};export{ie as default};
