import{k as K,i as U,r as u,l as D,j as e,B as x,m as C}from"./index-D_cEefWi.js";import{o as M,s as b,u as F,F as N,a as g,c as f,d as j,e as p,I as y,f as v,t as V}from"./input-BE6YdM2V.js";import{u as P,e as R,a as L,c as T,C as k,f as E,b as I}from"./fetch-eecNlH2-.js";function G(){const{executePost:s,isLoading:l,isError:m}=P(R.changeEmail());return{changeEmail:async n=>{const t=await s(n);if(t!=null&&t.success)return t.success===!0?!0:t==null?void 0:t.message;throw new Error(t==null?void 0:t.message)},isLoading:l,isError:m}}function H(){const{executePost:s,isLoading:l,isError:m}=P(R.validChangeEmail());return{validChangeEmail:async n=>{const t=await s(n);if(t!=null&&t.success)return t==null?void 0:t.success;throw new Error(t==null?void 0:t.message)},isLoading:l,isError:m}}const O=M({email:b({required_error:"Email là bắt buộc"}).email("Email không hợp lệ"),currentPassword:b().min(1,"Yêu cầu nhập mật khẩu hiện tại.")}),Q=M({code:b().min(6,"Mã xác thực phải có ít nhất 6 ký tự")}),W=()=>{const{toast:s}=K(),l=U(),[m,o]=u.useState("email"),[n,t]=u.useState(120),[_,h]=u.useState(!1),{userInfo:d,updateUserInfo:S}=D(),{changeEmail:w}=G(),{validChangeEmail:q}=H(),r=F({resolver:V(O),defaultValues:{email:""}}),c=F({resolver:V(Q),defaultValues:{code:""}});u.useEffect(()=>{let i;return n>0?i=setInterval(()=>{t(a=>a-1)},1e3):h(!0),()=>clearInterval(i)},[n]);const A=async()=>{try{if(h(!1),!await w({email:r.getValues("email"),current_password:r.getValues("currentPassword")})){s({variant:"destructive",title:"Lỗi",description:"Không thể gửi lại mã xác thực"}),h(!0);return}t(120),s({title:"Thành công",description:"Mã xác thực mới đã được gửi"})}catch(i){s({variant:"destructive",title:"Lỗi",description:i instanceof Error?i.message:"Đã có lỗi xảy ra"}),h(!0)}},X=async i=>{try{const a=await w({email:i.email,current_password:i.currentPassword});if(!a){s({variant:"destructive",title:"Lỗi",description:"Đã có lỗi xảy ra"});return}if(a===!0){s({title:"Thành công",description:"Đổi email thành công!"}),r.reset(),c.reset(),o("email"),l(C.VERIFy_EMAIL);return}S({...d,Email:a}),t(120),h(!1),o("verify"),s({title:"Thành công",description:"Vui lòng kiểm tra email để lấy mã xác thực"})}catch(a){s({variant:"destructive",title:"Lỗi",description:a instanceof Error?a.message:"Đã có lỗi xảy ra"})}},B=async i=>{try{if(!await q({code:i.code})){s({variant:"destructive",title:"Lỗi",description:"Đã có lỗi xảy ra"});return}s({title:"Thành công",description:"Email đã được thay đổi thành công"}),r.reset(),c.reset(),o("email"),S({...d,"2fa":"0",VerifiedEmail:"0"}),l(C.VERIFy_EMAIL)}catch(a){s({variant:"destructive",title:"Lỗi",description:a instanceof Error?a.message:"Đã có lỗi xảy ra"})}};return m==="verify"?e.jsx("div",{className:"container mx-auto max-w-md py-8",children:e.jsxs(L,{children:[e.jsxs(T,{children:[e.jsx(k,{children:"Xác thực thay đổi email"}),e.jsxs(E,{className:"space-y-2",children:[e.jsxs("p",{children:["Vui lòng nhập mã xác thực đã được gửi đến email: ",d==null?void 0:d.Email]}),n>0&&e.jsxs("p",{className:"text-sm text-muted-foreground",children:["Mã xác thực còn hiệu lực trong: ",n,"s"]})]})]}),e.jsx(I,{children:e.jsx(N,{...c,children:e.jsx("form",{onSubmit:c.handleSubmit(B),id:"valid-email",children:e.jsxs("div",{className:"space-y-6",children:[e.jsx(g,{control:c.control,name:"code",render:({field:i})=>e.jsxs(f,{children:[e.jsx(j,{children:"Mã xác thực"}),e.jsx(p,{children:e.jsx(y,{...i,type:"text",placeholder:"Nhập mã xác thực"})}),e.jsx(v,{})]})}),e.jsxs("div",{className:"flex justify-between gap-3",children:[e.jsxs("div",{className:"flex gap-3",children:[e.jsx(x,{type:"button",variant:"outline",onClick:()=>{o("email"),c.reset()},children:"Quay lại"}),_&&e.jsx(x,{type:"button",variant:"outline",onClick:A,children:"Gửi lại mã"})]}),e.jsx(x,{type:"submit",form:"valid-email",disabled:c.formState.isSubmitting||n<=0||!c.formState.isValid,children:c.formState.isSubmitting?"Đang xác thực...":"Xác thực"})]})]})})})})]})}):e.jsx("div",{className:"container mx-auto max-w-xl py-8",children:e.jsxs(L,{children:[e.jsxs(T,{children:[e.jsx(k,{children:"Thay đổi email"}),e.jsx(E,{children:"Sau khi thay đổi thành công Email trở về trạng thái chưa kích hoạt, đồng thời tính năng xác thực 2 lớp sẽ bị tắt."}),e.jsx(E,{children:"Sử dụng menu Xác thực email và Kích hoạt xác thực 2 lớp để bật lại các tính năng nâng cao."})]}),e.jsx(I,{children:e.jsx(N,{...r,children:e.jsxs("form",{onSubmit:r.handleSubmit(X),className:"space-y-6",id:"request-change-email",children:[e.jsx(g,{control:r.control,name:"currentPassword",render:({field:i})=>e.jsxs(f,{children:[e.jsx(j,{children:"Mật khẩu hiện tại"}),e.jsx(p,{children:e.jsx(y,{type:"password",...i})}),e.jsx(v,{})]})}),e.jsx(g,{control:r.control,name:"email",render:({field:i})=>e.jsxs(f,{children:[e.jsx(j,{children:"Email mới"}),e.jsx(p,{children:e.jsx(y,{type:"email",placeholder:"Nhập địa chỉ email mới",...i})}),e.jsx(v,{})]})}),e.jsx(x,{type:"submit",form:"request-change-email",className:"w-fit flex justify-end",disabled:r.formState.isSubmitting,children:r.formState.isSubmitting?"Đang xử lý...":"Tiếp tục"})]})})})]})})};export{W as default};
